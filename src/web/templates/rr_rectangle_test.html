<!DOCTYPE html>
<html>


<head>
    <meta charset='utf-8' />
    <title>Mapbox GL Draw Assisted Rectangle</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.js'></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.css' rel='stylesheet' />
    <script src="static/DrawAssistedRectangle.min.js?25"></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.css'
        type='text/css' />
    <style>
            body { margin:0; padding:0; }
            #map { position:absolute; top:0; bottom:0; width: 80%; }
            .marker {
    			border: none;
    			cursor: pointer;
    			height: 32px;
    			width: 32px;
    			background-image: url(static/marker.png);
    			background-color: rgba(0, 0, 0, 0);
    			transform: translate(28px, 56px, 0);
			}
			.container{
    			height: 100%;
    			display: -webkit-flex;
    			display: flex;
    			-webkit-flex-direction: row;
    			flex-direction: row;
			}
			.fixed{
    			width: 20%;
			}
			.flex-item{
    			flex-grow: 1;
			}
			.flatpickr-calendar{
				font-size: 12px;
			}
			
        </style>

</head>

<body>
	<div class="container">
    	<div id="slidemenu" class = "fixed">
			<div class="input" id="input_frame">
				<h4>Choose points from the map</h4>
				<img src="static/letter_a.png"> <input type="text" id="inputSource" value="" readonly><br>
				
				<div class="input" id="target_add">
				<img src="static/letter_b.png"> <input type="text" id="inputTarget" value="" readonly> 
				<button id="new_target" value="Add" onClick="add()" style="display:none; position:relative;">+</button>
				</div>
				<div class="input" id="input_target"></div>
				<br>
                <select id="select_departure" onchange="departure(this.value)">
  					<option value="now">Leave now</option>
  					<option value="later">Depart at</option>
				</select>
				<input type="text" style="display:none;" id="dateTimePicker" placeholder="Please select Date Time" data-input>
				<br><br>
				<button class="clearbutton" id="clear_button" onClick="clearFields()">Clear</button> <button class="button" id="getResults" onClick="getResults()">Get Directions</button>
			</div>

		</div>
		
        <div data-role="page" id="main_page" data-theme="a" class = "flex-item">
			<div class="map_container" data-role="content">
				<div id="map"></div>
				<div class="shadow"></div>
			</div>
		</div>
	</div>
    
    
	
    <script>
        const STYLES_DRAW = [

            {
                "id": "gl-draw-line",
                "type": "line",
                "filter": ["all", ["==", "$type", "LineString"], ["!=", "mode", "static"]],
                "layout": {
                    "line-cap": "round",
                    "line-join": "round"
                },
                "paint": {
                    "line-color": "#FF0000",
                    "line-width": 2
                }
            },
            {
                "id": "gl-draw-polygon-fill",
                "type": "fill",
                "filter": ["all", ["==", "$type", "Polygon"], ["!=", "mode", "static"]],
                "paint": {
                    "fill-color": "#FF0000",
                    "fill-outline-color": "#D20C0C",
                    "fill-opacity": 0.1
                }
            },

            {
                "id": "gl-draw-polygon-stroke-active",
                "type": "line",
                "filter": ["all", ["==", "$type", "Polygon"], ["!=", "mode", "static"]],
                "layout": {
                    "line-cap": "round",
                    "line-join": "round"
                },
                "paint": {
                    "line-color": "#D20C0C",
                    "line-width": 2
                }
            },

            {
                "id": "gl-draw-polygon-and-line-vertex-halo-active",
                "type": "circle",
                "filter": ["all", ["==", "meta", "vertex"], ["==", "$type", "Point"], ["!=", "mode", "static"]],
                "paint": {
                    "circle-radius": 5,
                    "circle-color": "#FFF"
                }
            },

            {
                "id": "gl-draw-polygon-and-line-vertex-active",
                "type": "circle",
                "filter": ["all", ["==", "meta", "vertex"], ["==", "$type", "Point"], ["!=", "mode", "static"]],
                "paint": {
                    "circle-radius": 3,
                    "circle-color": "#D20C0C",
                }
            },

            {
                "id": "gl-draw-line-static",
                "type": "line",
                "filter": ["all", ["==", "$type", "LineString"], ["==", "mode", "static"]],
                "layout": {
                    "line-cap": "round",
                    "line-join": "round"
                },
                "paint": {
                    "line-color": "#FF0000",
                    "line-width": 3
                }
            },
            {
                "id": "gl-draw-polygon-fill-static",
                "type": "fill",
                "filter": ["all", ["==", "$type", "Polygon"], ["==", "mode", "static"]],
                "paint": {
                    "fill-color": "#ee0508",
                   
                    "fill-opacity": 0.8
                }
            },
            {
                "id": "gl-draw-polygon-stroke-static",
                "type": "line",
                "filter": ["all", ["==", "$type", "Polygon"], ["==", "mode", "static"]],
                "layout": {
                    "line-cap": "round",
                    "line-join": "round"
                },
                "paint": {
                    "line-color": "#c40b0b",
                   
                    "line-width": 2
                }
            }
        ];

        function clearFields() {
            console.log("deleting rectangle")
    		draw.deleteAll()
    	}
    	
        mapboxgl.accessToken = '{{ ACCESS_KEY }}';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v9',
            center: [13.4050, 52.5200],
            zoom: 12
        });
        

        const DirectSelectWithoutMiddleVertexMode = MapboxDraw.modes.direct_select;

        DirectSelectWithoutMiddleVertexMode.toDisplayFeatures = function (state, geojson, push) {
          if (state.featureId === geojson.properties.id) {
            geojson.properties.active = 'true';
            push(geojson);
            /*createSupplementaryPoints(geojson, {
              map: this.map,
              midpoints: false,
              selectedPaths: state.selectedCoordPaths
            }).forEach(push);*/
          } else {
            geojson.properties.active = 'false';
            push(geojson);
          }
          this.fireActionable(state);
        };

        const SimpleSelectWithoutMiddleVertexMode = MapboxDraw.modes.simple_select;

        SimpleSelectWithoutMiddleVertexMode.toDisplayFeatures = function (state, geojson, push) {
          if (state.featureId === geojson.properties.id) {
            geojson.properties.active = 'true';
            //boxSelecting: false;
            //boxSelectElement: null;
            dragMoving: true;
            canDragMove: true;
            push(geojson);
          } else {
            geojson.properties.active = 'false';
            push(geojson);
          }
          this.fireActionable(state);
        }

        

        var modes = MapboxDraw.modes;
        modes.draw_assisted_rectangle = DrawAssistedRectangle.default;

        var draw = new MapboxDraw({
        	//modes: Object.assign({
            //    direct_select: DirectSelectWithoutMiddleVertexMode
            //}, modes),
            modes: modes,
            displayControlsDefault: false,
            controls: {
                polygon: true,
                trash: true
            },
            userProperties: true,
            boxSelect: false,
            clickBuffer: 0,
            styles: STYLES_DRAW
        });
        map.addControl(draw);

        var draw_features = null;
        map.on('draw.create', function (feature) {
            console.log(feature);
            draw_features = feature;
        });
        map.on("draw.modechange", (e) => {
            console.log("changing mode")
            console.log(e.mode)
            if (e.mode === "draw_polygon") {
                draw.changeMode("draw_assisted_rectangle");
            }

            if (e.mode === "simple_select") {
            	console.log(draw_features.features[0])
                //draw.changeMode("direct_select");
                //console.log("changing mode to direct select")
                draw.changeMode("direct_select", { featureId: draw_features.features[0].id });
            }
        });

        map.on("draw.update", (feature) => {
            console.log("rectangle is being updated")
            console.log(feature);
            draw_features = feature;
        });


    </script>

</body>

</html>