<!DOCTYPE html>
<html>
<head>
		<meta charset='utf-8' />
		<title>Show drawn polygon area</title>
        <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
        <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.js'></script>
		<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.css' rel='stylesheet' />
        <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.2.3/flatpickr.css">
        
        <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.js'></script>
		<link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.css' type='text/css' />
	<style>
            body { margin:0; padding:0; }
            #map { position:absolute; top:0; bottom:0; width: 80%; }
            .marker {
    			border: none;
    			cursor: pointer;
    			height: 32px;
    			width: 32px;
    			background-image: url(static/marker.png);
    			background-color: rgba(0, 0, 0, 0);
    			transform: translate(28px, 56px, 0);
			}
			.container{
    			height: 100vh;
    			display: -webkit-flex;
    			display: flex;
    			-webkit-flex-direction: row;
    			flex-direction: row;
			}
			.fixed{
    			width: 20%;
			}
			.flex-item{
    			flex-grow: 1;
			}
			.flatpickr-calendar{
				font-size: 12px;
			}
			
      </style>
</head>
<body>
	<div class="container">
    	<div id="slidemenu" class = "fixed">
			<div class="input" id="input_frame">
				<h4>Choose points from the map</h4>
				<img src="static/letter_a.png"> <input type="text" id="inputSource" value="" readonly><br>
				
				<div class="input" id="target_add">
				<img src="static/letter_b.png"> <input type="text" id="inputTarget" value="" readonly> 
				<button id="new_target" value="Add" onClick="add()" style="display:none; position:relative;">+</button>
				</div>
				<div class="input" id="input_target"></div>
				<br>
                <select id="select_departure" onchange="departure(this.value)">
  					<option value="now">Leave now</option>
  					<option value="later">Depart at</option>
				</select>
				<input type="text" style="display:none;" id="dateTimePicker" placeholder="Please select Date Time" data-input>
				<br><br>
				<button class="clearbutton" id="clear_button" onClick="clearFields()">Clear</button> <button class="button" id="getResults" onClick="getResults()">Get Directions</button>
			</div>

		</div>
		
        <div data-role="page" id="main_page" data-theme="a" class = "flex-item">
			<div class="map_container" data-role="content">
				<div id="map"></div>
				<div class="shadow"></div>
			</div>
		</div>
	</div>

	<script>
	mapboxgl.accessToken = '{{ ACCESS_KEY }}';
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v9',
        center: [13.4050, 52.5200],
        zoom: 12
    });

    var draw = null;

    var timer = 0;
    var delay = 250;
    var prevent = false;

    var markers = []
    var popups = []

   	var startLon = -1;
	var startLat = -1;

	var timestamp = new Date().getTime();
    var time_changed = false;

    /*$(document).on('click',function(event){
        console.log("clicking document");
        console.log(event.target)
    });*/
	
    map.on('click', function(e) {
    	timer = setTimeout(function() {
            if (!prevent) {
            	var latitude = e.lngLat.lat;
                var longitude = e.lngLat.lng;
                //doWork()
                
				var str = Number((latitude).toFixed(6)) + "," + Number((longitude).toFixed(6));

				var coord = { lat:latitude, lon:longitude }
				console.log(coord.lat)
	
                console.log(str)
                
                //if(document.getElementById('inputSource').hidden == false) { 
                	if(document.getElementById('inputSource').value == "") {
        				//add marker
                        // create a HTML element for each feature
                        startLon = longitude;
    					startLat = latitude;
    					
            			var el = document.createElement('div');
            			el.className = 'marker';
            			el.style.right = '-5px';
                        el.style.top = '-12px';

                        el.addEventListener('click', e => {
                            e.stopPropagation();
                            //functions
                            console.log("source" + " clicked")
                            
                            var popup = new mapboxgl.Popup({closeOnClick: false, anchor: 'top'})
                            .setLngLat({lat:latitude, lng: longitude})
                            .setHTML("<strong>source</strong>")
                            .addTo(map);

                            popup.on('close', function(e) {
                                console.log("popup closed")
                            })

                            popups.push(popup);
                            
                        }, true);

            			// make a marker for each feature and add to the map
            			var marker = new mapboxgl.Marker(el)
              				.setLngLat(e.lngLat)
              				.addTo(map);
          				
              			markers.push(marker);

              			document.getElementById('inputSource').value = str;

              			document.getElementById('inputTarget').value = "Select polygon";


              			if(!draw) {
            				draw = new MapboxDraw({
            					displayControlsDefault: false,
            					controls: {
            					}
            				});
            				map.addControl(draw);

            				draw.changeMode('draw_polygon');
            			 
            				map.on('draw.create', updateArea);
            				map.on('draw.delete', updateArea);
            				map.on('draw.update', updateArea);
              			}
    					
        			}
            }
            prevent = false;
        }, delay);
    });

    function departure(selectedValue) {
        time_changed = true;
        console.log(selectedValue)
        if(selectedValue == "later"){
        	var picker = document.getElementById ( "dateTimePicker" ) ;
        	picker.style.display = "inline" ;
        	$("#dateTimePicker").flatpickr({
        		enableTime: true,
        		dateFormat: "F, d Y H:i",
        		defaultDate: new Date().getTime(),
        		onChange: function(selectedDates, dateStr, instance) {
                    selectedDates.forEach(function (date){
    					//console.log(date)
                        //console.log(date.getFullYear(), date.getDate(), date.getMonth(), date.getTime());
                        timestamp = date.getTime()
                        //console.log(timestamp)
                    })
                }
    		});
        }
        if(selectedValue == "now"){
        	var picker = document.getElementById ( "dateTimePicker" ) ;
        	picker.style.display = "none" ;
        	timestamp = new Date().getTime()
        }
    }
    
    function clearFields() {
        console.log("clearing map")
    	document.getElementById('inputSource').value = "";
    	document.getElementById('inputTarget').value = "";

		draw.deleteAll();
		map.removeControl(draw);
		draw = null;
    	var j;
    	for (j = 0; j < markers.length; j++) {
    		markers[j].remove();
    		if (popups[j]){
    			popups[j].remove();
        	}
    	}

		if (map.getLayer("rr_layer")) {
		    map.removeLayer("rr_layer");
		}

		if (map.getSource("rr_layer")) {
		    map.removeSource("rr_layer");
		}

		var picker = document.getElementById ( "dateTimePicker" ) ;
    	picker.style.display = "none" ;

    	$("#select_departure").val('now');
    	time_changed = false;
		
    	startLon = -1;
    	startLat = -1;
    	markers = []
    	popups = []
    }
    
    function getResults() {
    	//console.log(startLon, startLat, targets.length) 
    	if(startLon == -1 || startLat == -1 || !polygon_coords) {
    		alert("Some coordinates are missing."); 
       	}
       	else if(isNaN(startLon) || isNaN(startLat)) {
    		alert("Coordinates are not defined correctly."); 
       	}
       	else {
    		// ajax the JSON to the server
    		if(!time_changed){
    			timestamp = new Date().getTime();
        	}
    		console.log(timestamp)
    		var data_input = {"startLon": startLon, "startLat": startLat, "coordinates":polygon_coords, "timestamp":timestamp}
			
    		$.post("receiver_region", JSON.stringify(data_input) , function(res){
				console.log(res)
				map.addLayer({
                    "id": "rr_layer",
                    "type": "circle",
                    "source": {
	                    "type": "geojson",
	                    "data": res
	                },
                    'paint': {
                    	'circle-radius': 10,
                    	// color circles by rr
                    	// https://docs.mapbox.com/mapbox-gl-js/style-spec/#expressions-match
                    	'circle-color': [
							'match',
							['get', 'marker-color'],
							"r", '#ff0000',
							"b", '#223b53',
							/* other */ '#ccc'
						]
                    }
                });
				
    		}); 
       	}        
    }

    function addPathLayer(marker_id, geom){
    	map.addLayer({
            "id": "paths"+marker_id,
            "type": "line",
            "source": {
                "type": "geojson",
                "data": geom
            },
            "layout": {
                "line-join": "round",
                "line-cap": "round"
            },
            'paint': {
            	"line-width": 6,
            	// color routes by type
            	// https://docs.mapbox.com/mapbox-gl-js/style-spec/#expressions-match
            	'line-color': [
					'match',
					['get', 'line-color'],
					"r", '#ff0000',
					"b", '#223b53',
					/* other */ '#ccc'
				]
            }
        });
    }

	var polygon_coords = null;
	function updateArea(e) {
	if (e.type == 'draw.create' || e.type == 'draw.update'){
		var data = draw.getAll();
		console.log(data);
		console.log(data.features);
		//console.log(data.features[0].geometry.coordinates);
		polygon_coords = data.features[0].geometry.coordinates;
		console.log(polygon_coords);
	}else if (e.type == 'draw.delete'){
		polygon_coords = null;
	}

}
 
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.2.3/flatpickr.js"></script>
</body>
</html>